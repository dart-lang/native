// Copyright (c) 2024, the Dart project authors. Please see the AUTHORS file
// for details. All rights reserved. Use of this source code is governed by a
// BSD-style license that can be found in the LICENSE file.

import { StreamLanguage } from "@codemirror/language";
import { dart } from "@codemirror/legacy-modes/mode/clike";
import { EditorState } from "@codemirror/state";
import { basicSetup, EditorView } from "codemirror";
import { createEffect, onMount } from "solid-js";
import { Box } from "styled-system/jsx";
import { $bindings } from "~/lib/bindings";
import { $theme, editorThemeConfig } from "~/lib/theme";

/**
 * Displays output generated by ffigen in a read only codemirror editor
 */
export const BindingsViewer = () => {
  const [bindings] = $bindings;

  let editorRef: HTMLDivElement;
  let editor: EditorView;

  onMount(() => {
    editor = new EditorView({
      doc: bindings(),
      extensions: [
        basicSetup,
        StreamLanguage.define(dart),
        editorThemeConfig.of([$theme.editorTheme()]),
        EditorView.theme({
          "&": {
            height: "100%",
          },
        }),
        // set readOnly true
        EditorState.readOnly.of(true),
      ],
      parent: editorRef!,
    });

    return () => {
      editor.destroy();
    };
  });

  createEffect(() => {
    if (editor) {
      // change the content whenever the generated bindings are updated
      editor.dispatch({
        changes: { from: 0, to: editor.state.doc.length, insert: bindings() },
      });
    }
  });

  createEffect(() => {
    if (editor) {
      editor.dispatch($theme.editorThemeTransaction());
    }
  });

  return <Box height="full" flexGrow={1} ref={editorRef} />;
};
